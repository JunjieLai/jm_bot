# Railway 内存分析和解决方案

## 当前问题

Railway 免费套餐配置：
- **vCPU**: 1 核
- **内存**: ~512MB
- **结果**: OOM (Out of Memory) 崩溃

## 内存占用分析

### 基础内存（启动时）
- Python 3.11: ~50MB
- Telegram Bot 库: ~30MB
- JMComic 库: ~20MB
- 健康检查服务器: ~5MB
- **小计**: ~105MB

### 运行时内存（下载时）
即使使用单线程 + 流式发送：

- 单张图片下载: ~5-10MB
- 图片解码（Pillow）: ~10-15MB
- Telegram 上传缓冲: ~10-20MB
- JMComic 内部缓冲: ~10-20MB
- **单次操作峰值**: ~140-170MB

### 总内存峰值
基础 105MB + 运行时 170MB = **275MB**

**理论上应该能在 512MB 内运行！**

## 可能的问题

### 1. 内存碎片
频繁分配和释放内存导致碎片化。

### 2. 图片未及时释放
即使 close()，Python GC 可能延迟回收。

### 3. JMComic 库内存泄漏
第三方库可能有内存管理问题。

### 4. Railway 内存统计
Railway 可能统计虚拟内存而非实际使用。

## 解决方案

### 方案 A：升级 Railway 套餐（推荐）

**Hobby Plan**: $5/月
- 内存: 8GB
- vCPU: 8 核
- 稳定运行，无忧

### 方案 B：切换到其他平台

#### 1. Render
- **免费套餐**: 512MB 内存，但有休眠问题
- **付费**: $7/月，无休眠

#### 2. Fly.io
- **免费套餐**: 256MB 内存（太小）
- **付费**: $1.94/月起，1GB 内存

#### 3. Heroku
- **Eco**: $5/月，512MB
- **Basic**: $7/月，512MB

#### 4. 自己的 VPS
- **Vultr/DigitalOcean**: $5/月
- 1GB 内存，完全控制

### 方案 C：继续优化代码（风险高）

可以尝试：

1. **强制 GC**
   ```python
   import gc
   gc.collect()  # 每发送完一张图片后
   ```

2. **降低图片质量**
   ```python
   # 发送前压缩图片
   from PIL import Image
   img = Image.open(file)
   img.thumbnail((1024, 1024))  # 降低分辨率
   ```

3. **边下载边删除**
   ```python
   # 发送完立即删除图片文件
   img_file.unlink()
   ```

但这些都是"治标不治本"，因为：
- Railway 免费套餐本来就不适合长时间运行的下载任务
- 512MB 对于图片处理应用确实偏小

## 推荐方案

### 短期（立即）
1. **等待当前部署**，看 Monkey Patch 是否真的限制到单线程
2. **查看 Railway 日志**，确认是否出现 `[PATCH]` 消息

### 中期（本周）
**升级到 Railway Hobby Plan ($5/月)**
- 性价比最高
- 无需迁移
- 立即解决所有内存问题

### 长期（可选）
考虑迁移到 VPS：
- 更多控制权
- 更便宜（$5/月 1GB 内存）
- 可以同时运行其他服务

## 成本对比

| 平台 | 月费 | 内存 | 优点 | 缺点 |
|------|------|------|------|------|
| Railway Free | $0 | 512MB | 简单 | 不稳定OOM |
| **Railway Hobby** | **$5** | **8GB** | **稳定推荐** | 需付费 |
| Render | $7 | 512MB | 无休眠 | 贵且内存小 |
| Fly.io | $2 | 1GB | 便宜 | 配置复杂 |
| VPS | $5 | 1GB | 灵活 | 需自己运维 |

## 结论

**最佳方案**: 升级到 Railway Hobby Plan ($5/月)
- 一键升级，无需代码改动
- 8GB 内存，完全够用
- 稳定运行，无后顾之忧

如果不想付费，可以尝试：
1. 方案 C 的代码优化
2. 迁移到 Fly.io ($2/月, 1GB)
3. 自己租 VPS ($5/月, 1GB)

但从时间成本和稳定性考虑，**强烈建议直接升级 Railway**。
